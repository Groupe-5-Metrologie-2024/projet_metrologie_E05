#Modules ---------------------------------------------------------------------------------------------------------------

import csv
import matplotlib.pyplot as plt
import statistics as stat
import scipy
import numpy as np
from scipy.special import kv, iv
import os
import time
from scipy.interpolate import interp1d
from scipy.constants import mu_0
from scipy.constants import epsilon_0
from scipy.integrate import quad
from scipy.special import iv as I
from scipy.special import kv as K
from scipy.optimize import fsolve

print('')
print('')
print('#----------------- Menu d\'activation des programmes DEBUT')
print('')
print('')

# 1 = on
# 0 = off

Activation_Production_CSV_rho = 1
Activation_Graphique_résistivité_Température = 1
Activation_Graphique_Température_Temps = 1


if Activation_Production_CSV_rho == 1 :
    print('Activation_Production_CSV_rho','|','on')
else :
    print('Activation_Production_CSV_rho','|','off')

if Activation_Graphique_résistivité_Température == 1 :
    print('Activation_Graphique_Resistivite_Temperature','|','on')
else :
    print('Activation_Graphique_Resistivite_Temperature','|','off')

if Activation_Graphique_Température_Temps == 1 :
    print('Activation_Graphique_Température_Temps','|' , 'on')
else :
    print('Activation_Graphique_Température_Temps','|' , 'off')

print('')
print('')
print('#----------------- Menu d\'activation des programmes FIN')
print('')
print('')
#----------------- Modification generales DEBUT

if Activation_Graphique_résistivité_Température == 1 :  
    #Nombre de lignes - 1 du fichier de temperature
    nombre_lignes_conservees = 31

if Activation_Graphique_Température_Temps == 1 :
    fichier_entree = "Données/Temperature"
    Materiau_choisit = 'Invar36'

if Activation_Production_CSV_rho == 1 :
    Nom_materiau_utilisé = "Données_cuivre"

#Cuivre :
b=1.58*10**(-3)
omega=2*np.pi*100*10**3
mur=1
mu0=mu_0
e0=epsilon_0
er=1
a=10.43*10**(-3)
n=1
rho_approx=820*10**(-9)

#Molybdene :

#Invar36 :

#----------------- Modification generales FIN


#fonctions DEBUT ---------------------------------------------------------------------------------------------------------------

def ouverture_fichier(nomfichier):
    with open(nomfichier, 'r') as csvfile:
        csvreader = csv.reader(csvfile)
        xc = []
        i = 0
        for row in csvreader:
            xc.append(float(row[1]))
            i += 1
            if i >= 100000:
                break
    return xc

def list_to_csv(input_list, file_name):

    # Obtenir le chemin du dossier actuel
    current_directory = os.getcwd()
    # Combiner le chemin du dossier avec le nom du fichier
    file_path = os.path.join(current_directory, file_name)
    
    with open(file_path, 'w', newline='') as csvfile:
        writer = csv.writer(csvfile)
        for row in input_list:
            writer.writerow([row])

def attendre_fichier(nom_fichier, delai_attente=1):

    while not os.path.exists(nom_fichier):
        print(f"En attente du fichier {nom_fichier}...")
        time.sleep(delai_attente)

def conserver_premieres_lignes(fichier_entree, nombre_lignes_conservees, fichier_sortie):
    # Ouvrir le fichier d'entrée en mode lecture et le fichier de sortie en mode écriture
    with open(fichier_entree, 'r', newline='') as csv_entree, open(fichier_sortie, 'w', newline='') as csv_sortie:
        lecteur_csv = csv.reader(csv_entree)
        ecrivain_csv = csv.writer(csv_sortie)
        
        # Parcourir chaque ligne du fichier CSV
        for indice_ligne, ligne in enumerate(lecteur_csv, start=1):
            # Écrire la ligne dans le fichier de sortie si elle est avant ou à la ligne spécifiée
            if indice_ligne <= nombre_lignes_conservees:
                ecrivain_csv.writerow(ligne)
            else:
                # Si on a atteint la ligne spécifiée, sortir de la boucle
                break

def modifier_virgule_csv(fichier_entree, fichier_sortie):

    with open(fichier_entree, 'r', newline='') as csv_entree, open(fichier_sortie, 'w', newline='') as csv_sortie:
        lecteur_csv = csv.reader(csv_entree)
        ecrivain_csv = csv.writer(csv_sortie)
        
        # Parcourir chaque ligne du fichier CSV
        for ligne in lecteur_csv:
            ligne_modifiee = []
            # Parcourir chaque élément de la ligne
            for element in ligne:
                try:
                    # Tente de convertir l'élément en un nombre
                    nombre = float(element)
                    # Si la conversion réussit, ajoute une virgule devant le nombre
                    ligne_modifiee.append(',' + element)
                except ValueError:
                    # Si la conversion échoue, conserve l'élément tel quel
                    ligne_modifiee.append(element)
            
            # Écrire la ligne modifiée dans le fichier de sortie
            csv_sortie.write(','.join(ligne_modifiee) + '\n')

def supprimer_fichier(fichier):
    try:
        os.remove(fichier)
        print(f"Le fichier {fichier} a été supprimé avec succès.")
    except FileNotFoundError:
        print(f"Le fichier {fichier} n'existe pas.")
    except Exception as e:
        print(f"Une erreur s'est produite lors de la suppression du fichier : {e}")

def supprimer_premiere_ligne(fichier_entree, fichier_sortie):
    lignes_restantes = []
    with open(fichier_entree, 'r', newline='') as csv_entree:
        lecteur_csv = csv.reader(csv_entree)
        # Ignorer la première ligne
        next(lecteur_csv)
        # Collecter les lignes restantes
        for ligne in lecteur_csv:
            lignes_restantes.append(ligne)
    
    # Écrire les lignes restantes dans le fichier de sortie
    with open(fichier_sortie, 'w', newline='') as csv_sortie:
        ecrivain_csv = csv.writer(csv_sortie)
        ecrivain_csv.writerows(lignes_restantes)

def list_to_csv(input_list, file_name):

    # Obtenir le chemin du dossier actuel
    current_directory = os.getcwd()
    # Combiner le chemin du dossier avec le nom du fichier
    file_path = os.path.join(current_directory, file_name)
    
    with open(file_path, 'w', newline='') as csvfile:
        writer = csv.writer(csvfile)
        for row in input_list:
            writer.writerow([row])

#fonctions FIN ---------------------------------------------------------------------------------------------------------------
if Activation_Production_CSV_rho == 1 :
    print('')
    print('#CODE 1 DEBUT ---------------------------------------------------------------------------------------------------------------')
    print('')
    print('')


    print('')
    print('')
    print('#CODE 1 FIN ---------------------------------------------------------------------------------------------------------------')


if Activation_Graphique_résistivité_Température == 1 :
    print('')
    print('#CODE 2 DEBUT ---------------------------------------------------------------------------------------------------------------')
    print('')
    print('')

    #Nom des fichiers ---------------------------------------------------------------------------------------------------------------   

    nom_fichier_temperature = "Temperature_fini_PALIER"             
                                
    nom_fichier_resistivite = "Resistivite_fini"             

    #Modifications pour les CSV ------------------------------------------------------------------------------------------------------   

    fichier_entree = "Données/Temperature_palier"
    fichier_entree2 = "300_valeurs_de_rho"
    fichier_temportaire = "Temperature_2"
    fichier_temportaire2 = "Temperature_3"
    fichier_entree_3 = "Resistivite3"

    #T
    print('MODIFICATION DU CSV DE TEMPERATURE')
    supprimer_premiere_ligne(fichier_entree, fichier_temportaire)
    conserver_premieres_lignes(fichier_temportaire, nombre_lignes_conservees, fichier_temportaire2)
    modifier_virgule_csv(fichier_temportaire2, nom_fichier_temperature)

    #R
    print('MODIFICATION DU CSV DE RESISTIVITE')
    conserver_premieres_lignes(fichier_entree2, nombre_lignes_conservees, fichier_entree_3)
    modifier_virgule_csv(fichier_entree_3, nom_fichier_resistivite)

    #Delete
    print('SUPPRESSION DES FICHIERS TEMPORAIRES')
    supprimer_fichier(fichier_temportaire)
    supprimer_fichier(fichier_temportaire2)
    supprimer_fichier(fichier_entree_3)

    #Listes graphiques depuis les CSV ---------------------------------------------------------------------------------------------------------------
    print('ATTENTE DES FICHIER')
    attendre_fichier(nom_fichier_resistivite)
    attendre_fichier(nom_fichier_temperature)
    print('FICHIERS OBTENUS')

    x = ouverture_fichier(nom_fichier_temperature)
    y = ouverture_fichier(nom_fichier_resistivite) 

    #Generation des graphiques -----------------------------------------------------------------------------------------------------------------------
    print('GENERATION GRAPHIQUE 1')

    plt.plot(x, y)  
    plt.xlabel('Température')  
    plt.ylabel('Résistivité')  
    plt.title('Graphique de la résistivite de l\'echantillon en fonction de la temperature')  
    plt.grid(True)  
    plt.show() 

    #-------------------------------------------------------------------------------------------------------------------------------------------------

    print('')
    print('')
    print('#CODE 2 FIN ---------------------------------------------------------------------------------------------------------------')

if Activation_Graphique_Température_Temps == 1 :
    print('')
    print('#CODE 3 DEBUT -------------------------------------------------------------------------------------------------------------')
    print('')
    print('')
    
    fichier_entree = "Données/Temperature"
    nom_fichier_temperature = f"Temperature_{Materiau_choisit}_ARDUINO"             
    fichier_temportaire = "Temperature_2"

    print('MODIFICATION DU CSV DE TEMPERATURE')
    supprimer_premiere_ligne(fichier_entree, fichier_temportaire)
    modifier_virgule_csv(fichier_temportaire, nom_fichier_temperature)

    print('SUPPRESSION DU FICHIER TEMPORAIRE')
    supprimer_fichier(fichier_temportaire)

    print('ATTENTE DU FICHIER')
    attendre_fichier(nom_fichier_temperature)

    y = ouverture_fichier(nom_fichier_temperature)
    x = list(range(0,len(y)))

    print('GENERATION GRAPHIQUE 2')
    plt.plot(x, y)  
    plt.xlabel('Temps')  
    plt.ylabel('Temperature')  
    plt.title('Graphique de la résistivite de l\'echantillon en fonction de la temperature')  
    plt.grid(True)  
    plt.show() 

    print('')
    print('')
    print('#CODE 3 FIN ---------------------------------------------------------------------------------------------------------------')
